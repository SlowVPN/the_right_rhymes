{% extends "dictionary/base.html" %}
{% block title %}{{ domain }} â‹… {% endblock %}
{% block content %}
<div id="wrapper">
    <div id="content-container">
        <div id="content" class="group">
            <div class="entry-content">
                {% if image %}
                    <figure class="center-block">
                        <img src="{{ image }}"
                          alt="{{ domain }}"
                          property="image"
                          scale="0"/>
                    </figure>
                    <div class="headword-image">{{ domain }}</div>
                {% else %}
                    <div class="headword">{{ domain }}</div>
                {% endif %}
                {% if senses %}
                    {% if senses|length > 1 %}
                    <h3 class="trr-list-header">{{ senses|length }} senses in the domain of <strong>{{ domain }}</strong></h3>
                    {% elif senses|length == 1 %}
                    <h3 class="trr-list-header">{{ senses|length }} sense in the domain of <strong>{{ domain }}</strong></h3>
                    {% endif %}
                    <div class="trr-list">
                    {% for sense in senses %}
                        <div class="trr-list-group-item">
                            <div>
                                <strong>
                                    <a href="{% url 'entry' sense.slug %}#{{sense.xml_id}}">{{ sense.headword }}</a>
                                </strong>
                            </div>

                                {% for example in sense.examples %}
                                <div>
                                    <span class="date">{{ example.release_date_string }}</span>
                                    <!--<span class="artist"><a href="{% url 'artist' example.artist_slug %}">{{example.artist_name}}</a></span>-->
                                    <span class="songTitle">"<a href="{% url 'song' example.song_slug %}">{{example.song_title}}</a>"</span>
                                    {% if example.featured_artists %}
                                    <span> feat. </span>
                                    {% for feat in example.featured_artists %}
                                    <span class="artist"><a href="{% url 'artist' feat.slug %}">{{feat.name}}</a>{% if not forloop.last %}, {% endif %}</span>
                                    {% endfor %}
                                    {% endif %}
                                    <span class="album">[{{example.album }}]</span>

                                    <div class="lyric">{{ example.linked_lyric|safe }}</div>
                                </div>
                                {% endfor %}

                        </div>
                    {% endfor %}
                    </div>
                {% endif %}
            </div>
            {% csrf_token %}
            <div id="cloud"></div>
        </div>
    </div>
</div>
    {% load staticfiles %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
<script src="/static/dictionary/js/word_cloud.js"></script>
<script>

var fill = d3.scale.category20();

var endpoint = '/domains/{{slug}}/json';
function getData(callback) {
    return $.getJSON(
            endpoint,
            {'csrfmiddlewaretoken': '{{csrf_token'},
            function(data) {
                var parsed = $.parseJSON(data);
                var children = parsed.children;
                $.each(children, function(i, child) {
                    return {
                        word: child.name,
                        weight: child.example_count
                    };
                });
            }
        );
}

getData(function(data) {
    console.log(data);
    d3.layout.cloud().size([500, 500])
            .words(data.map(function (d) {
                return {text: d.word, size: d.weight};
            }))
            .padding(5)
            .rotate(function () {
                return ~~(Math.random() * 2) * 90;
            })
            .font("Impact")
            .fontSize(function (d) {
                return d.size;
            })
            .on("end", draw)
            .start();

    function draw(words) {
        d3.select("#cloud").append("svg")
                .attr("width", 300)
                .attr("height", 300)
                .append("g")
                .attr("transform", "translate(150,150)")
                .selectAll("text")
                .data(words)
                .enter().append("text")
                .style("font-size", function (d) {
                    return d.size + "px";
                })
                .style("font-family", "Impact")
                .style("fill", function (d, i) {
                    return fill(i);
                })
                .attr("text-anchor", "middle")
                .attr("transform", function (d) {

                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function (d) {
                    return d.text;
                });
    }

    function drawUpdate(words) {
        d3.layout.cloud().size([500, 500])
                .words(words)
                .padding(5)
                .rotate(function () {
                    return ~~(Math.random() * 2) * 90;
                })
                .font("Impact")
                .fontSize(function (d) {
                    return d.size;
                })
                .start();


        d3.select("svg")
                .selectAll("g")
                .attr("transform", "translate(150,150)")
                .selectAll("text")
                .data(words).enter().append("text")
                .style("font-size", function (d) {
                    return d.size + "px";
                })
                .style("font-family", "Impact")
                .style("fill", function (d, i) {
                    return fill(i);
                })

                .attr("transform", function (d) {

                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function (d) {
                    return d.text;
                });


    }

});

</script>
{% endblock %}
